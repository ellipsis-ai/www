version: 2
jobs:
  build:
    # branches:
    #   only:
    #     - master
    docker:
      - image: ellipsis/circleci_www:1.0
        environment:
          AWS_REGION: us-east-1

    working_directory: ~/www
    steps:
      - checkout
      - restore_cache:
          key: www-gem-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
      - run:
          name: Install dependencies
          command: |
            bundle check --path=vendor/bundle || bundle install --path=vendor/bundle --jobs=4 --retry=3
      - save_cache:
          key: www-gem-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
          paths:
            - "vendor/bundle"
      - run:
          name: Compile site
          command: |
            bundle exec jekyll build
      - run:
          name: No crawlers
          command: |
            echo -e "User-agent: *\nDisallow: /" >> robot.txt
      - run:
          name: "Deploy on staging: www.el.tc, el.tc. nocache.www.el.tc"
          command: |
            mkdir ~/.aws
            echo -e "[el-wwwstag-deployer]\naws_access_key_id = ${WWWSTAG_AWS_ACCESS_KEY}\naws_secret_access_key = ${WWWSTAG_AWS_SECRET_KEY}\nregion = us-east-1" >> ~/.aws/credentials
            aws s3 sync ./dist s3://www.el.tc/ --acl=public-read --profile=el-wwwstag-deployer
      - run:
          name: "Maybe deploy on prod"
          command: |
            if [ "${CIRCLE_BRANCH}" == "prod" ]
            then
              echo -e "[el-wwwprod-deployer]\naws_access_key_id = ${WWWPROD_AWS_ACCESS_KEY}\naws_secret_access_key = ${WWWPROD_AWS_SECRET_KEY}\nregion = us-east-1" >> ~/.aws/credentials
              aws s3 sync ./dist s3://www.ellipsis.ai/ --acl=public-read --profile=el-wwwprod-deployer
            fi
